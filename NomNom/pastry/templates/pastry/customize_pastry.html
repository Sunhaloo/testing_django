{% extends 'base.html' %}
{% load static %}

{% block title %}Customize Cake{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Cake Designer - BakeCraft</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-brown: #6B4423;
            --light-brown: #8B5A3C;
            --cream: #FFF8E7;
            --dark-brown: #4A2C17;
            --accent-gold: #D4A574;
            --white: #FFFFFF;
            --gray-light: #F5F5F5;
            --shadow: rgba(107, 68, 35, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: #E8DBC7;
            /* doodle pattern */
            background-image: url("{% static 'images/cake-pattern.png' %}");
            background-repeat: repeat;
            /* adjust size of each doodle */
            background-size: 150px 150px;
            color: #4A2C17;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }


        .container {
            max-width: 800px;
            margin: 4rem auto;
            padding: 0 2rem;
            position: relative;
        }

        .form-container {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .form-title {
            font-size: 1.5rem;
            color: var(--primary-brown);
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
        }

        /* Form layout */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .required {
            color: #e74c3c;
        }

        /* Select dropdown */
        .form-select {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--white);
            color: var(--dark-brown);
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B4423' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 3px rgba(107, 68, 35, 0.1);
        }

        /* Text input */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 3px rgba(107, 68, 35, 0.1);
        }

        /* Number input */
        .number-input {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .number-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-brown);
            color: var(--white);
            border: none;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .number-btn:hover {
            background: var(--light-brown);
        }

        .number-btn:disabled {
            background: #CCCCCC;
            cursor: not-allowed;
        }

        .number-value {
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        /* Order summary */
        .order-summary {
            background: #f0f0f0;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
            margin-top: 2rem;
        }

        .summary-title {
            font-size: 1.3rem;
            color: var(--primary-brown);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E8D5C4;
        }

        .summary-item:last-child {
            border-bottom: none;
            padding-top: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-brown);
        }

        .add-to-cart-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--primary-brown), var(--light-brown));
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 68, 35, 0.3);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary-brown);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Back button styles */
        .back-button {
            position: absolute;
            left: -150px;
            top: 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background-color: #000000;
            color: var(--white);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .back-button:hover {
            background-color: #333333;
            transform: translateX(-3px);
        }

        .back-button i {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <main class="container">
        <a href="/#where" class="back-button">
            <i class="fas fa-arrow-left"></i>
            <span>Back</span>
        </a>
        <div class="form-container">
            <h1 class="form-title">Customize Your Cake</h1>

            <form id="cake-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-grid">
                    <!-- Flavour -->
                    <div class="form-group">
                        <label class="form-label">
                            Flavour <span class="required">*</span>
                        </label>
                        <select id="flavour" class="form-select" required>
                            <option value="" selected>Select Flavour</option>
                            <option value="Vanilla" data-price="0">Vanilla</option>
                            <option value="Chocolate" data-price="175">Chocolate</option>
                            <option value="Strawberry" data-price="175">Strawberry</option>
                            <option value="Red Velvet" data-price="275">Red Velvet</option>
                            <option value="Carrot" data-price="250">Carrot</option>
                            <option value="Lemon" data-price="200">Lemon</option>
                        </select>
                    </div>

                    <!-- Cake Size -->
                    <div class="form-group">
                        <label class="form-label">
                            Cake Size <span class="required">*</span>
                        </label>
                        <select id="size" class="form-select" required>
                            <option value="" selected>Select Size</option>
                            <option value="6" data-price="900" data-cm="15">Small (15 cm)</option>
                            <option value="8" data-price="1250" data-cm="20">Medium (20 cm)</option>
                            <option value="10" data-price="1750" data-cm="25">Large (25 cm)</option>
                            <option value="12" data-price="2500" data-cm="30">Extra Large (30 cm)</option>
                        </select>
                    </div>

                    <!-- Filling -->
                    <div class="form-group">
                        <label class="form-label">
                            Filling <span class="required">*</span>
                        </label>
                        <select id="filling" class="form-select" required>
                            <option value="" selected>Select Filling</option>
                            <option value="None" data-price="0">No Filling</option>
                            <option value="Cream" data-price="300">Cream</option>
                            <option value="Fruit" data-price="375">Fruit</option>
                            <option value="Chocolate Ganache" data-price="325">Chocolate Ganache</option>
                            <option value="Caramel" data-price="325">Caramel</option>
                            <option value="Nutella" data-price="450">Nutella</option>
                        </select>
                    </div>

                    <!-- Frosting -->
                    <div class="form-group">
                        <label class="form-label">
                            Frosting <span class="required">*</span>
                        </label>
                        <select id="frosting" class="form-select" required>
                            <option value="" selected>Select Frosting</option>
                            <option value="Buttercream" data-price="0">Buttercream</option>
                            <option value="Cream Cheese" data-price="175">Cream Cheese</option>
                            <option value="Whipped Cream" data-price="150">Whipped Cream</option>
                            <option value="Fondant" data-price="550">Fondant</option>
                            <option value="Ganache" data-price="375">Ganache</option>
                            <option value="Meringue" data-price="450">Meringue</option>
                        </select>
                    </div>

                    <!-- Decoration -->
                    <div class="form-group">
                        <label class="form-label">
                            Decoration <span class="required">*</span>
                        </label>
                        <select id="decoration" class="form-select" required>
                            <option value="" selected>Select Decoration</option>
                            <option value="None" data-price="0">No Decoration</option>
                            <option value="Flowers" data-price="300">Flowers</option>
                            <option value="Sprinkles" data-price="100">Sprinkles</option>
                            <option value="Chocolate Shavings" data-price="175">Chocolate Shavings</option>
                            <option value="Fresh Fruit" data-price="375">Fresh Fruit</option>
                            <option value="Nuts" data-price="225">Nuts</option>
                            <option value="Candles" data-price="150">Candles</option>
                        </select>
                    </div>

                    <!-- Layers -->
                    <div class="form-group">
                        <label class="form-label">
                            Layers
                        </label>
                        <div class="number-input">
                            <button type="button" class="number-btn" id="decrease-layers" disabled>-</button>
                            <span class="number-value" id="layers-value">1</span>
                            <button type="button" class="number-btn" id="increase-layers">+</button>
                        </div>
                    </div>

                    <!-- Pickup date -->
                    <div class="form-group">
                        <label class="form-label">
                            Pickup Date <span class="required">*</span>
                        </label>
                        <input type="date" id="pickup-date" class="form-input" required>
                    </div>

                    <!-- Cake message -->
                    <div class="form-group full-width">
                        <label class="form-label">Cake Message</label>
                        <input type="text" id="cake-message" class="form-input"
                            placeholder="Enter your message (max 50 characters)" maxlength="50">
                    </div>
            </form>
        </div>

        <!-- Order summary -->
        <div class="order-summary">
            <h2 class="summary-title">Order Summary</h2>
            <div id="summary-items">
                <!-- Empty initially -->
            </div>
            <div class="summary-item">
                <span>Total</span>
                <span id="total-price">Rs. 0</span>
            </div>
            <button class="add-to-cart-btn" id="add-to-cart">
                <span>ðŸ›’</span>
                <span>Add to Cart</span>
            </button>
        </div>
    </main>

    <!-- Toast notification -->
    <div class="toast" id="toast">
        <span id="toast-message">Cake added to cart!</span>
    </div>

    <script>
        const cakeState = {
            flavour: '',
            filling: '',
            frosting: '',
            decoration: '',
            size: '',
            sizeCm: '',
            layers: 1,
            message: '',
            uploadedFile: null,
            pickupDate: '',
            basePrice: 0
        };

        document.addEventListener('DOMContentLoaded', function () {
            initializeEventListeners();
            updateOrderSummary();
        });

        function initializeEventListeners() {
            ['flavour', 'filling', 'frosting', 'decoration', 'size'].forEach(id => {
                document.getElementById(id).addEventListener('change', function () {
                    cakeState[id] = this.value;
                    if (id === 'size') {
                        const selectedOption = this.options[this.selectedIndex];
                        cakeState.basePrice = parseInt(selectedOption.dataset.price) || 0;
                        cakeState.sizeCm = selectedOption.dataset.cm || '';
                    }
                    updateOrderSummary();
                });
            });

            document.getElementById('increase-layers').addEventListener('click', function () {
                if (cakeState.layers < 5) {
                    cakeState.layers++;
                    updateLayersDisplay();
                    updateOrderSummary();
                }
            });

            document.getElementById('decrease-layers').addEventListener('click', function () {
                if (cakeState.layers > 0) {
                    cakeState.layers--;
                    updateLayersDisplay();
                    updateOrderSummary();
                }
            });

            document.getElementById('pickup-date').addEventListener('change', function () {
                cakeState.pickupDate = this.value;
                updateOrderSummary();
            });

            document.getElementById('cake-message').addEventListener('input', function () {
                cakeState.message = this.value;
            });

            document.getElementById('add-to-cart').addEventListener('click', function () {
                const form = document.getElementById('cake-form');
                const requiredFields = form.querySelectorAll('[required]');
                for (let field of requiredFields) {
                    if (!field.value) {
                        showToast('Please fill all required fields!');
                        field.focus();
                        return;
                    }
                }

                // Check pickup date
                const selectedDate = new Date(cakeState.pickupDate);
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                if (selectedDate < now) {
                    showToast('Pickup date cannot be in the past!');
                    return;
                }

                // Calculate total price
                const totalPrice = document.getElementById('total-price').textContent.replace('Rs. ', '').replace(/,/g, '');

                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

                // Create form data
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrftoken);
                formData.append('flavour', cakeState.flavour);
                formData.append('filling', cakeState.filling);
                formData.append('frosting', cakeState.frosting);
                formData.append('decoration', cakeState.decoration);
                formData.append('size', cakeState.sizeCm + ' cm');
                formData.append('layers', cakeState.layers);
                formData.append('cake_message', cakeState.message);
                formData.append('pickup_date', cakeState.pickupDate);
                formData.append('price', totalPrice);

                // Submit form
                fetch('/pastry/customize/', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            showToast('Cake added to cart!');
                            setTimeout(() => {
                                window.location.href = '/cart/';
                            }, 1000);
                        } else {
                            showToast('Error adding cake to cart');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Error adding cake to cart');
                    });
            });
        }

        function updateLayersDisplay() {
            document.getElementById('layers-value').textContent = cakeState.layers;
            document.getElementById('decrease-layers').disabled = cakeState.layers <= 1;
            document.getElementById('increase-layers').disabled = cakeState.layers >= 5;
        }

        function updateOrderSummary() {
            const summaryItems = document.getElementById('summary-items');
            let totalPrice = cakeState.basePrice;
            let summaryHTML = '';

            if (cakeState.size && cakeState.flavour) {
                summaryHTML += `<div class="summary-item">
              <span>${cakeState.sizeCm} cm ${cakeState.flavour} Cake</span>
              <span>Rs. ${cakeState.basePrice.toLocaleString('en-IN')}</span>
          </div>`;
            }

            if (cakeState.layers > 1) {
                const layerCost = (cakeState.layers - 1) * 700;
                totalPrice += layerCost;
                summaryHTML += `<div class="summary-item">
              <span>Additional Layers (${cakeState.layers - 1})</span>
              <span>+ Rs. ${layerCost.toLocaleString('en-IN')}</span>
          </div>`;
            }

            ['filling', 'frosting', 'decoration'].forEach(id => {
                if (cakeState[id]) {
                    const select = document.getElementById(id);
                    const price = parseInt(select.options[select.selectedIndex].dataset.price) || 0;
                    if (price > 0) {
                        totalPrice += price;
                        summaryHTML += `<div class="summary-item">
                      <span>${cakeState[id]} ${id.charAt(0).toUpperCase() + id.slice(1)}</span>
                      <span>+ Rs. ${price.toLocaleString('en-IN')}</span>
                  </div>`;
                    }
                }
            });

            if (cakeState.pickupDate) {
                const date = new Date(cakeState.pickupDate);
                const formattedDate = date.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                summaryHTML += `<div class="summary-item">
              <span>Pickup Date</span>
              <span>${formattedDate}</span>
          </div>`;
            }

            summaryItems.innerHTML = summaryHTML;
            document.getElementById('total-price').textContent = `Rs. ${totalPrice.toLocaleString('en-IN')}`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Set minimum pickup date to today
        const pickupDateInput = document.getElementById('pickup-date');
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        pickupDateInput.setAttribute('min', today);


    </script>
    {% endblock %}